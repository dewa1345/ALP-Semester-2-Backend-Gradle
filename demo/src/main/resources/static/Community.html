<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title> EcoV</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .bubble-chat {
            position: relative;
            background: #fff;
            border: 2px solid #222;
            border-radius: 20px;
            padding: 12px 16px 12px 16px;
            margin-bottom: 10px;
            max-width: 80%;
            min-width: 120px;
            box-sizing: border-box;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .bubble-chat .bubble-tail {
            position: absolute;
            left: -18px;
            top: 18px;
            width: 24px;
            height: 24px;
            overflow: hidden;
        }

        .bubble-chat .bubble-tail svg {
            display: block;
        }

        .bubble-chat .bubble-content {
            flex: 1;
        }

        .bubble-chat .bubble-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid #678e34;
            object-fit: cover;
            margin-right: 6px;
        }

        .bubble-chat .bubble-name {
            font-weight: 600;
            font-size: 0.95em;
            color: #678e34;
            margin-bottom: 2px;
        }

        .bubble-chat .bubble-text {
            font-size: 1em;
            color: #222;
            word-break: break-word;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0 0 0 / 60%);
        }

        .modal.flex {
            display: flex !important;
        }

        .modal.hidden {
            display: none !important;
        }

        .modal-content {
            background-color: #f6fdf4;
            margin: 60px auto auto auto;
            padding: 24px 18px;
            border: 1.5px solid #b5d6a2;
            width: 95%;
            max-width: 420px;
            border-radius: 14px;
            box-shadow: 0 4px 24px 0 rgba(103, 142, 52, 0.10);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: #678e34;
            text-decoration: none;
            cursor: pointer;
        }

        /* NAVBAR STYLES */
        .navbar {
            width: 100vw;
            height: 60px;
            background: #235b37;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(35, 91, 55, 0.08);
        }

        .navbar button {
            margin-left: 24px;
            background: #fff;
            color: #2e944b;
            border: 2px solid #2e944b;
            border-radius: 8px;
            padding: 8px 22px 8px 14px;
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 8px rgba(46, 148, 75, 0.07);
            cursor: pointer;
            transition: background 0.15s, color 0.15s;
        }

        .navbar span {
            margin-right: 32px;
            color: #fff;
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .navbar-blur {
            background: rgba(34, 34, 34, 0.7) !important;
            box-shadow: 0 2px 8px rgba(34, 34, 34, 0.15);
            backdrop-filter: blur(2px);
            transition: background 0.2s;
        }

        .navbar-transparent {
            background: transparent !important;
            box-shadow: none !important;
            backdrop-filter: none !important;
            transition: background 0.2s;
        }

        .navbar-behind-modal {
            z-index: 1 !important;
        }

        /* Extra space for fixed navbar */
        .navbar-spacer {
            height: 70px;
        }
    </style>
</head>

<body class="bg-green-50 text-gray-800 min-h-screen flex flex-col">
    <!-- NAVBAR ATAS -->
    <nav class="navbar">
        <button onclick="window.history.back()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="22"
                height="22">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
            BACK
        </button>
        <span>Community</span>
    </nav>
    <div class="navbar-spacer"></div>
    <main class="flex-grow">
        <div class="container mx-auto py-8 px-4">
            <div class="flex items-center justify-between mb-6">
                <h1 class="text-3xl font-bold text-[#678E34]">Forum Komunitas Recycle</h1>
            </div>
            <div class="flex flex-col lg:flex-row gap-8">
                <!-- Sidebar komunitas -->
                <aside class="lg:w-1/4 w-full">
                    <div class="bg-white rounded-xl shadow p-4">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-semibold">Pilih Komunitas</h2>
                            <button
                                class="bg-[#678E34] text-white px-2 py-1 md:px-3 md:py-1.5 rounded-lg font-semibold hover:bg-[#4a6b24] transition flex items-center gap-1 md:gap-2 text-xs md:text-sm w-auto md:w-fit min-w-[36px] min-h-[32px]"
                                style="min-width:36px;min-height:32px;" onclick="openCreateCommunityModal()">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor" class="w-4 h-4 md:w-5 md:h-5">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 4v16m8-8H4" />
                                </svg>
                                <span class="hidden sm:inline">Create Community</span>
                            </button>
                        </div>
                        <div class="max-h-96 overflow-y-auto pr-2" style="scrollbar-width: thin;">
                            <ul id="communityList" class="space-y-2"></ul>
                        </div>
                    </div>
                </aside>
                <!-- Konten komunitas -->
                <main class="flex-1">
                    <div id="communityContent" class="bg-white rounded-xl shadow p-6 min-h-[350px]">
                        <p class="text-gray-500 text-center">Silakan pilih komunitas untuk melihat detailnya.</p>
                    </div>
                </main>
            </div>
        </div>
    </main>

    <div id="createCommunityModal" class="modal hidden">
        <div class="modal-content">
            <span class="close" onclick="closeCreateCommunityModal()">&times;</span>
            <h2 class="text-xl font-bold mb-4 text-[#678E34]">Buat Komunitas Baru</h2>
            <form id="createCommunityForm" class="space-y-3">
                <div>
                    <label class="block font-semibold mb-1">Nama Komunitas</label>
                    <input type="text" name="namakomunitas" class="w-full border rounded px-3 py-2" required>
                </div>
                <div>
                    <label class="block font-semibold mb-1">Lokasi</label>
                    <input type="text" name="Lokasi" class="w-full border rounded px-3 py-2" required>
                </div>
                <div>
                    <label class="block font-semibold mb-1">Deskripsi Komunitas</label>
                    <textarea name="deskripsi" class="w-full border rounded px-3 py-2" required></textarea>
                </div>
                <div>
                    <label class="block font-semibold mb-1">Logo Komunitas</label>
                    <input type="file" name="logo" accept="image/*" class="w-full border rounded px-3 py-2">
                </div>
                <button type="submit"
                    class="w-full bg-[#678E34] text-white py-2 rounded font-bold hover:bg-[#4a6b24]">Create</button>
            </form>
        </div>
    </div>

    <script>
    const currentUserId = parseInt(localStorage.getItem("userId")) || null;

    console.log("Logged-in currentUserId:", currentUserId);

    let communities = {};
    let selectedCommunityKey = null;
    let joinedCommunities = JSON.parse(localStorage.getItem('joinedCommunities') || '[]');
    let chatRefreshTimer = null; // Timer for chat refresh

    function fetchCommunities() {
        fetch("/api/communities")
            .then(res => res.json())
            .then(data => {
                communities = {};
                data.forEach(c => {
                    const key = c.communityName.replace(/\s+/g, '_');
                    communities[key] = {
                        id: c.idCommunity,
                        name: c.communityName,
                        description: c.description,
                        // Fix: use c.Location or c.location
                        location: c.Location || c.location || "",
                        members: c.members,
                        logoUrl: c.logoUrl || null,
                        creatorId: c.creatorId
                        };
                });
                renderCommunityList();
            });
    }

    function renderCommunityList() {
        const list = document.getElementById('communityList');
        if (!list) return;

        const currentUserId = parseInt(localStorage.getItem("userId")) || null;
        console.log("Logged-in currentUserId:", currentUserId);

        const keys = Object.keys(communities);

        // Group communities
        const creatorKeys = keys.filter(k => communities[k].creatorId == currentUserId);
        const joinedKeys = keys.filter(k => !creatorKeys.includes(k) && joinedCommunities.includes(k));
        const otherKeys = keys.filter(k => !creatorKeys.includes(k) && !joinedCommunities.includes(k));

        const orderedKeys = [...creatorKeys, ...joinedKeys, ...otherKeys];

        let customLogos = {};
        try { customLogos = JSON.parse(localStorage.getItem('customCommunityLogos') || '{}'); } catch {}

        list.innerHTML = orderedKeys.map(key => {
            const c = communities[key];
            const joined = joinedCommunities.includes(key);
            const isCreator = c.creatorId == currentUserId;

            console.log("Rendering:", c.name, "creatorId:", c.creatorId, "currentUserId:", currentUserId);

            const defaultLogo = "gambar/community-default.jpg";
            const imgUrl = customLogos[key] || c.logoUrl || defaultLogo;

            return `
                <li>
                    <button class="w-full flex items-center gap-3 text-left px-3 py-2 rounded hover:bg-green-100 relative" onclick="selectCommunity('${key}')">
                        <img src="${imgUrl}" alt="${c.name}" class="w-8 h-8 rounded object-cover">
                        ${c.name}
                        ${
                        isCreator
                            ? '<span class="ml-2 px-2 py-0.5 rounded-full bg-blue-600 text-white text-xs">Creator</span>'
                            : (joined ? '<span class="ml-2 px-2 py-0.5 rounded-full bg-[#678E34] text-white text-xs">Joined</span>' : '')
                        }
                    </button>
                </li>
            `;
        }).join('');
    }

    function selectCommunity(key) {
        const c = communities[key];
        if (!c) return;
        selectedCommunityKey = key;
        renderCommunityList();
        fetch(`/api/communities/${c.id}/members`)
            .then(res => res.json())
            .then(members => {
                const grid = document.getElementById("memberGrid");
                grid.innerHTML = members.map(m => {
                const imgSrc = m.hasPhoto
                    ? `http://localhost:8080/api/users/photo/${m.email}`
                    : "Gambar/profile.jpeg";
                return `
                    <div class="flex flex-col items-center text-center">
                    <img src="${imgSrc}" class="w-16 h-16 rounded-full object-cover border-2 border-green-400">
                    <span class="mt-1 text-sm bg-green-100 px-2 py-0.5 rounded-full">${m.name}</span>
                    </div>`;
                }).join('');
            });

        document.getElementById('communityContent').innerHTML = `
            <h2 class="text-2xl font-bold text-[#678E34] mb-2">${c.name}</h2>
            <p class="mb-4 text-gray-700">${c.description}</p>
            <div class="mb-6">
                <h3 class="font-semibold text-lg mb-1">Anggota Komunitas</h3>
                <div id="memberGrid" class="flex flex-wrap gap-4 mb-6 mt-3"></div>
            </div>
            <div class="mb-20">
                <h3 class="font-semibold text-lg mb-2">Chat Komunitas</h3>
                <div class="bg-green-50 border border-green-200 rounded-lg p-3 h-40 overflow-y-auto mb-2" id="chatBox">
                    <!-- chat messages will be rendered here -->
                </div>
                <div class="flex gap-2">
                    <input id="chatInput" type="text" class="flex-1 border rounded px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-[#678E34]" placeholder="Ketik pesan...">
                    <button onclick="sendChat()" class="bg-[#678E34] text-white px-4 py-1 rounded hover:bg-[#4a6b24]">Kirim</button>
                </div>
            </div>
            ${
                c.creatorId == currentUserId
                    ? ''
                    : (
                        joinedCommunities.includes(key)
                            ? `<button onclick="leaveCommunity('${key}')" id="leaveBtn" class="fixed bottom-8 right-8 bg-red-600 text-white px-6 py-3 rounded-full shadow-lg font-bold text-lg hover:bg-red-800 z-50">Leave Komunitas</button>`
                            : `<button onclick="joinCommunity('${key}')" id="joinBtn" class="fixed bottom-8 right-8 bg-[#678E34] text-white px-6 py-3 rounded-full shadow-lg font-bold text-lg hover:bg-[#4a6b24] z-50">Join Komunitas</button>`
                    )
            }
        `;

        setTimeout(() => {
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter') {
                        sendChat();
                    }
                });
            }
            // Clear previous chat refresh timer if any
            if (chatRefreshTimer) {
                clearTimeout(chatRefreshTimer);
                chatRefreshTimer = null;
            }
            // Always call renderChatHistory after rendering chat box
            if (typeof window.renderChatHistory === "function") {
                window.renderChatHistory();
            }
        }, 100);
    } // <-- Fix: add missing closing bracket here

    function joinCommunity(key) {
        const id = communities[key].id;
        const userId = currentUserId;
        if (!userId) {
            alert("Anda harus login untuk join komunitas.");
            return;
        }

        fetch(`/api/communities/${id}/join?userId=${userId}`, { method: "POST" })
            .then(res => res.text())
            .then(msg => {
                alert(msg);
                if (!joinedCommunities.includes(key)) {
                    joinedCommunities.unshift(key);
                    localStorage.setItem('joinedCommunities', JSON.stringify(joinedCommunities));
                }
                selectCommunity(key);
                renderCommunityList();
            });
    }

    function leaveCommunity(key) {
        const userId = currentUserId;
        if (!userId) {
            alert("Anda harus login untuk keluar dari komunitas.");
            return;
        }

        const communityId = communities[key]?.id;
        if (!communityId) {
            alert("ID komunitas tidak ditemukan.");
            return;
        }

        fetch(`/api/communities/${communityId}/leave?userId=${userId}`, {
            method: "DELETE"
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => { throw new Error(text); });
            }
            return response.text();
        })
        .then(msg => {
            alert(msg);
            const idx = joinedCommunities.indexOf(key);
            if (idx !== -1) {
                joinedCommunities.splice(idx, 1);
                localStorage.setItem('joinedCommunities', JSON.stringify(joinedCommunities));
            }
            fetchCommunities();
            renderCommunityList();
            document.getElementById('communityContent').innerHTML = `<p class="text-gray-500 text-center">Silakan pilih komunitas untuk melihat detailnya.</p>`;
        })
        .catch(err => {
            alert("Error: " + err.message);
        });
    }

    function sendChat() {
        const input = document.getElementById('chatInput');
        if (!input || input.value.trim() === '') return;

        const msg = input.value;
        const key = selectedCommunityKey;
        const id = communities[key].id;

        if (!currentUserId) {
            alert("Anda harus login untuk mengirim pesan.");
            return;
        }

        fetch(`/api/communities/${id}/messages?userId=${currentUserId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(msg)
        })
            .then(res => res.text())
            .then(() => {
                input.value = '';
                // Clear previous chat refresh timer if any
                if (chatRefreshTimer) {
                    clearTimeout(chatRefreshTimer);
                    chatRefreshTimer = null;
                }
                // Always call renderChatHistory after sending a message
                if (typeof window.renderChatHistory === "function") {
                    window.renderChatHistory();
                }
            });
    }

    function renderChatHistory() {
        const key = selectedCommunityKey;
        if (!key || !communities[key]) return;

        const communityId = communities[key].id;

        fetch(`/api/communities/${communityId}/messages`)
            .then(res => res.json())
            .then(messages => {
                const chatBox = document.getElementById('chatBox');
                if (!chatBox) return;

                // Always clear chatBox before rendering
                chatBox.innerHTML = '';

                if (!Array.isArray(messages) || messages.length === 0) {
                    chatBox.innerHTML = `<div class="text-gray-400 text-sm text-center">Belum ada pesan. Mulai chat dengan komunitas!</div>`;
                    return;
                }

                // Sort messages by timestamp
                messages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                chatBox.innerHTML = messages.map(msg => {
                    // Defensive: check if msg.user exists
                    if (!msg.user) return '';
                    const isSender = msg.user.id_user === currentUserId;
                    const bubbleAlign = isSender ? 'justify-end' : 'justify-start';
                    const bubbleColor = isSender ? 'bg-green-100 border-green-300' : 'bg-white border-gray-300';
                    const timestamp = new Date(msg.timestamp).toLocaleTimeString('id-ID', { 
                        hour: '2-digit', 
                        minute: '2-digit'
                    });

                    return `
                        <div class="flex ${bubbleAlign} mb-3">
                            <div class="bubble-chat ${bubbleColor}">
                                ${!isSender ? `<img class="bubble-avatar" src="/api/users/photo/${msg.user.email}" 
                                    onerror="this.src='gambar/profile.jpeg'" alt="${msg.user.name}" />` : ''}
                                <div class="bubble-content">
                                    <div class="bubble-name">${msg.user.name}</div>
                                    <div class="bubble-text">${msg.communityMsg}</div>
                                    <div class="text-xs text-gray-500 mt-1">${timestamp}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                chatBox.scrollTop = chatBox.scrollHeight;

                // Setup auto-refresh for chat
                if (chatRefreshTimer) {
                    clearTimeout(chatRefreshTimer);
                }
                chatRefreshTimer = setTimeout(window.renderChatHistory, 5000);
            })
            .catch(err => {
                const chatBox = document.getElementById('chatBox');
                if (chatBox) {
                    chatBox.innerHTML = `<div class="text-red-500 text-sm text-center">Gagal memuat pesan.</div>`;
                }
                console.error("Error fetching chat messages:", err);
            });
    }

    // Attach to window so it is always available
    window.renderChatHistory = renderChatHistory;

    function openCreateCommunityModal() {
        const modal = document.getElementById('createCommunityModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');

        const navbar = document.querySelector('.navbar');
        if (navbar) {
            navbar.classList.add('navbar-behind-modal');
        }
    }

    function closeCreateCommunityModal() {
        const modal = document.getElementById('createCommunityModal');
        modal.classList.remove('flex');
        modal.classList.add('hidden');

        const navbar = document.querySelector('.navbar');
        if (navbar) {
            navbar.classList.remove('navbar-behind-modal');
        }
    }

    const createForm = document.getElementById('createCommunityForm');
    if (createForm) {
        createForm.onsubmit = function (e) {
            e.preventDefault();

            const email = localStorage.getItem("userEmail");
            if (!email) {
                alert("You must be logged in to create a community.");
                return;
            }

            const fd = new FormData(createForm);
            const communityName = fd.get('namakomunitas');
            const location = fd.get('Lokasi');
            const description = fd.get('deskripsi');
            const logoFile = fd.get('logo');

            // Read image (if any), then create community
            if (logoFile && logoFile.size > 0) {
                const reader = new FileReader();
                reader.onload = function (evt) {
                    const imageDataUrl = evt.target.result;
                    submitCommunity(null, logoFile, imageDataUrl);
                };
                reader.readAsDataURL(logoFile);
            } else {
                submitCommunity(null, null, null);
            }

            function submitCommunity(logoUrl, rawFile, imageDataUrl) {
                const payload = {
                    email: email,
                    communityName: communityName,
                    location: location,
                    description: description
                    // no logo included here anymore!
                };

                fetch("/api/communities", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                })
                .then(res => {
                    if (!res.ok) throw new Error("Failed to create community");
                    return res.json();
                })
                .then(savedCommunity => {
                    closeCreateCommunityModal();

                    // Upload logo separately using FormData
                    if (rawFile && imageDataUrl && savedCommunity?.idCommunity) {
                        uploadCommunityLogoToBackend(imageDataUrl, savedCommunity.idCommunity);
                    }

                    fetchCommunities(); // Refresh sidebar
                })
                .catch(err => {
                    alert("Error creating community: " + err.message);
                });
            }
        };
    }

// Used after community is created to upload image
    function uploadCommunityLogoToBackend(imageDataUrl, communityId) {
        if (!communityId) return;

        fetch(imageDataUrl)
            .then(res => res.blob())
            .then(blob => {
                const formData = new FormData();
                formData.append("communityId", communityId);
                formData.append("photo", blob, "logo.png");

                return fetch("http://localhost:8080/api/communities/photo", {
                    method: "PUT",
                    body: formData
                });
            })
            .then(res => res.text())
            .then(msg => console.log("Community logo uploaded:", msg))
            .catch(err => console.error("Community logo upload error:", err));
    }

        window.onload = function () {
            fetchCommunities();
            if (joinedCommunities.length > 0) {
                setTimeout(() => {
                    selectCommunity(joinedCommunities[0]);
                    // Ensure chat history is rendered after selecting the community
                    setTimeout(() => {
                        if (typeof window.renderChatHistory === "function") {
                            window.renderChatHistory();
                        }
                    }, 200);
                }, 200);
            }
        };
    </script>
    <!-- NAVBAR BAWAH (FOOTER) -->
    <footer class="bg-green-100 py-4 w-full shadow-md">
        <div class="container mx-auto px-4 text-center text-sm text-gray-600">
            &copy; 2025 Tim Creator ðŸŒ±. All rights reserved.
        </div>
    </footer>
</body>

</html>